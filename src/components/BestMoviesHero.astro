---
import { Icon } from 'astro-icon/components';
import { getTranslationFunction } from '../utils/localization.ts';
import { getRelativeLocaleUrl } from "astro:i18n";
import { Image } from 'astro:assets';

const { lang } = Astro.params;
const { films } = Astro.props;

const t = getTranslationFunction(lang);
---

<style>
  .arrow {
    height: 2.25rem; /* Adjust the height as needed */
    width: 2.25rem; /* Adjust the width as needed */
    opacity: 0.8; /* Slightly transparent */
  }

  .arrow:hover {
    transform: scale(1.2); /* Slightly enlarge on hover */
    transition: transform 0.2s ease-in-out;
    opacity: 1; /* Fully opaque on hover */
  }

  .fade-enter-active,
  .fade-leave-active {
    transition: opacity 0.2s;
  }

  .fade-enter,
  .fade-leave-to {
    opacity: 0;
  }

  .dots-container {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    position: absolute;
    bottom: 2rem; /* Position the dots container 2rem from the bottom */
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
  }

  /* Custom classes for responsive adjustments */
  .banner-container {
    /* Default height via inline style (70vh) will be overridden on mobile */
  }
  .banner-title {}
  .banner-subtitle {}
  .banner-synopsis {}
  .banner-button {}

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .banner-container {
      height: 100vh !important; /* Full viewport height on mobile */
      max-height: none !important; /* Remove max-height constraint */
      aspect-ratio: unset !important; /* Remove aspect ratio constraint */
    }
    .banner-title {
      font-size: 1.75rem !important; /* Smaller title on mobile */
    }
    .banner-subtitle {
      font-size: 1rem !impo rtant; /* Adjust subtitle size */
    }
    .banner-synopsis {
      font-size: 0.875rem !important; /* Smaller synopsis text */
    }
    .banner-button {
      padding: 0.75rem 1rem !important; /* Smaller button padding */
      font-size: 0.875rem !important;
    }
    .dots-container {
      bottom: 1rem; /* Adjust dots container position */
    }
    .arrow {
      
      height: 1.75rem; /* Smaller arrow size on mobile */
      width: 1.75rem; /* Smaller arrow size on mobile */
    }
    /* Reposition arrows on mobile so they do not overlap the banner text */
    .arrow-right {
      top: auto;
      bottom: 1rem;
      right: 1rem;
    }
    .arrow-left {
      top: auto;
      bottom: 1rem;
      left: 1rem;
    }
    .film-slide img {
      object-fit: cover !important;
      object-position: center 20% !important; /* Adjust vertical position */
      height: 100% !important;
      width: 100% !important;
    }
  }

  /* Mobile adjustments - CONTAINER, IMAGE AND TEXT */
  @media (max-width: 1023px) { /* Use lg breakpoint to match filmSlug.astro */
    .banner-container {
      height: 50vh !important; /* Increased from 33vh to 50vh for more vertical space */
      min-height: 350px !important; /* Increased minimum height to ensure adequate space */
      overflow: hidden !important; /* Ensure the image doesn't spill out */
    }
    
    .film-slide img {
      object-fit: cover !important;
      object-position: center 25% !important; /* Adjusted to show the important parts of movie posters */
      height: 100% !important;
      width: 100% !important;
    }
    
    /* Position text at bottom for mobile */
    .content-container {
      align-items: flex-end !important; /* Align to bottom */
      padding-bottom: 4rem !important; /* Increased padding to prevent overlap with controls */
    }
    
    /* Text styling for mobile */
    .banner-title {
      font-size: 1.5rem !important; /* Smaller title on mobile */
      line-height: 1.2 !important;
      margin-bottom: 0.25rem !important; /* Reduced margin to fit more content */
      padding-right: 1rem !important; /* Space for arrow */
    }
    
    .banner-subtitle {
      font-size: 0.875rem !important; /* Smaller subtitle */
      margin-bottom: 0.25rem !important;
    }
    
    .banner-synopsis {
      /* Show synopsis but with smaller text and fewer lines */
      display: -webkit-box !important; /* Make sure it's visible */
      -webkit-box-orient: vertical !important;
      font-size: 0.75rem !important; /* Smaller font size */
      line-height: 1.3 !important; /* Tighter line height */
      -webkit-line-clamp: 4 !important; /* Show all 4 lines, not just 2 */
      max-height: 4rem !important; /* Increased height to fit 4 lines */
      margin-bottom: 0.75rem !important; /* Increased bottom margin for separation */
      overflow: hidden !important; /* Ensure text doesn't overflow */
      text-overflow: ellipsis !important; /* Add ellipsis for truncated text */
    }
    
    .banner-button {
      padding: 0.5rem 1rem !important; /* Smaller button padding */
      font-size: 0.75rem !important; /* Smaller button text */
      margin-top: 0.75rem !important; /* Increased margin from synopsis */
    }
    
    /* Fix space between elements */
    .content-text-container {
      width: 80% !important; /* Limit width to make room for arrows */
      /* Fix vertical spacing between elements */
      & > * {
        margin-top: 0.25rem !important;
        margin-bottom: 0.25rem !important;
      }
      /* Override space-y-4 with more compact spacing */
      &.space-y-4 {
        --tw-space-y-reverse: 0 !important;
        margin-top: calc(0.5rem * calc(1 - var(--tw-space-y-reverse))) !important;
        margin-bottom: calc(0.5rem * var(--tw-space-y-reverse)) !important;
      }
    }
    
    /* Controls positioning */
    .dots-container {
      bottom: 1rem !important; /* Position dots closer to bottom */
    }
    
    .arrow {
      height: 1.5rem !important;
      width: 1.5rem !important;
    }
    
    .arrow-right {
      top: auto !important;
      bottom: 1rem !important;
      right: 1rem !important;
    }
    
    .arrow-left {
      top: auto !important;
      bottom: 1rem !important;
      left: 1rem !important;
    }
  }

  /* Custom animation for desktop only */
  @keyframes subtleBounce {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(5px); }
  }
  
  .animate-subtleBounce {
    /* Only apply animation on larger screens */
    @media (min-width: 1024px) {
      animation: subtleBounce 2s infinite ease-in-out;
    }
  }
  
  /* Mobile adjustments for arrows and dots */
  @media (max-width: 1023px) {
    /* Controls positioning */
    .dots-container {
      bottom: 0.5rem !important; /* Position dots closer to bottom */
      z-index: 20 !important; /* Ensure dots are above gradients */
      justify-content: center !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      padding: 0.25rem 0.5rem !important;
      background-color: rgba(0, 0, 0, 0.3) !important; /* Semi-transparent background */
      border-radius: 1rem !important; /* Rounded corners */
    }
    
    .dot {
      width: 0.5rem !important; /* Smaller dots */
      height: 0.5rem !important;
      margin: 0 0.25rem !important; /* Closer spacing */
    }
    
    /* Make dots more visible */
    .dot.bg-red-400 {
      background-color: #f56565 !important; /* Brighter red */
    }
    
    .arrow {
      height: 1.5rem !important;
      width: 1.5rem !important;
      background-color: rgba(0, 0, 0, 0.3) !important; /* Semi-transparent background */
      border-radius: 50% !important; /* Circular background */
      padding: 0.25rem !important; /* Padding around icon */
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .arrow-container {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 2.5rem !important;
      height: 2.5rem !important;
    }
    
    .arrow-right {
      top: auto !important;
      bottom: 0.75rem !important;
      right: 0.75rem !important;
      z-index: 20 !important; /* Ensure arrows are above gradients */
    }
    
    .arrow-left {
      top: auto !important;
      bottom: 0.75rem !important;
      left: 0.75rem !important;
      z-index: 20 !important; /* Ensure arrows are above gradients */
    }
    
    /* Disable animation on mobile */
    .animate-subtleBounce {
      animation: none !important;
    }
  }
</style>

<div class="banner-container mb-6 mx-0 relative w-full rounded" style="height: 70vh;" role="banner" aria-labelledby="banner-heading">
  {films.map((film, index) => (
    <div class={`absolute w-full h-full transition-opacity duration-300 ease-in-out film-slide ${index === 0 ? 'opacity-100' : 'opacity-0'}`}>
      <Image 
        src={film.extended_info.poster_max_quality_url}
        alt={t("Movie poster of %1").replace("%1", film.locationInfo.title)}
        class="w-full h-full object-cover"
        loading={index === 0 ? 'eager' : 'lazy'}
        width={1920}
        height={1080}
      />
      <div class="content-container absolute inset-0 flex items-center mx-auto px-6 container">
        <div class="content-text-container sm:w-1/2 lg:w-1/3 space-y-4 lg:space-y-4" style="z-index: 3;">
          <h1 id={`banner-heading-${index}`} class="banner-title text-3xl sm:text-5xl font-bold mb-2 sm:mb-4 text-white drop-shadow-xl">
            {film.locationInfo.title}
          </h1>
          <div class="banner-subtitle text-xl sm:text-2xl font-medium mb-1 sm:mb-2 text-red-400">
            {t("Sub | Dub")}
          </div>
          <p class="banner-synopsis text-lg sm:text-xl leading-relaxed text-gray-300 line-clamp-4">
            {film.locationInfo.synopsis}
          </p>
          <a href={getRelativeLocaleUrl(Astro.currentLocale, film.slug)} class="inline-block mt-2 sm:mt-4">
            <button class="banner-button bg-red-500 hover:bg-red-700 text-white font-semibold px-4 py-2 sm:px-6 sm:py-3 rounded shadow transition ease-in-out duration-150"  
                    aria-label={t("Discover %1").replace("%1", film.locationInfo.title)}>
              {t("DISCOVER THIS MOVIE")}
            </button>
          </a>
        </div>
      </div>
    </div>
  ))}

  <!-- Enhanced gradient overlay for better text contrast on mobile -->
  <div class="absolute w-full h-full bg-gradient-to-r from-black via-gray-800 to-transparent opacity-70" style="z-index: 1;"></div>

  <!-- Bottom gradient for text readability - more intense on mobile -->
  <div class="absolute inset-0" style="pointer-events: none; z-index: 2;">
    <div class="absolute bottom-0 w-full h-1/2 bg-gradient-to-b from-transparent via-transparent to-gray-900"></div>
  </div>

  <!-- Right Arrow -->
  <div class="absolute inset-y-0 right-0 flex items-center pr-4 lg:animate-subtleBounce arrow-right" style="z-index: 4;">
    <div class="arrow-container">
      <Icon name="fa-solid:chevron-right" class="arrow text-white cursor-pointer" aria-label={t("Next movie")}/>
    </div>
  </div>

  <!-- Left Arrow: Removed 'lg:flex hidden' so it's visible on all screen sizes -->
  <div class="absolute inset-y-0 left-0 flex items-center pl-4 lg:animate-subtleBounce arrow-left" style="z-index: 4;">
    <div class="arrow-container">
      <Icon name="fa-solid:chevron-left" class="arrow text-white cursor-pointer" aria-label={t("Previous movie")}/>
    </div>
  </div>

  <div class="dots-container space-x-3 lg:space-x-10" role="tablist" aria-label={t("Movie banner navigation")}>
    {films.map((_, dotIndex) => (
      <button
        class={`dot w-2 h-2 lg:w-3 lg:h-3 rounded-full cursor-pointer transform transition-transform duration-500 ease-in-out ${dotIndex === 0 ? 'bg-red-400 scale-125 lg:scale-150' : 'bg-gray-500 hover:bg-red-500'}`}
        aria-label={t("Go to movie %1").replace("%1", dotIndex + 1)}
        data-index={dotIndex}
        aria-controls={`banner-heading-${dotIndex}`}
        aria-selected={dotIndex === 0 ? 'true' : 'false'}
        role="tab"
      ></button>
    ))}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let activeIndex = 0;
    const films = Array.from(document.querySelectorAll('.film-slide'));
    const dots = Array.from(document.querySelectorAll('.dot'));

    function updateActiveSlide(newIndex) {
      films[activeIndex].classList.remove('opacity-100');
      films[activeIndex].classList.add('opacity-0');
      
      // Fix: Remove both scale-125 and lg:scale-150 classes
      dots[activeIndex].classList.remove('bg-red-400', 'scale-125', 'lg:scale-150');
      dots[activeIndex].setAttribute('aria-selected', 'false');
      dots[activeIndex].classList.add('bg-gray-500');

      activeIndex = newIndex;
      films[activeIndex].classList.remove('opacity-0');
      films[activeIndex].classList.add('opacity-100');
      dots[activeIndex].classList.remove('bg-gray-500');
      dots[activeIndex].setAttribute('aria-selected', 'true');
      
      // Fix: Add both scale-125 and lg:scale-150 classes
      dots[activeIndex].classList.add('bg-red-400', 'scale-125', 'lg:scale-150');
    }

    document.querySelector('.arrow-right').addEventListener('click', () => {
      const nextIndex = (activeIndex + 1) % films.length;
      updateActiveSlide(nextIndex);
    });

    document.querySelector('.arrow-left').addEventListener('click', () => {
      const prevIndex = (activeIndex - 1 + films.length) % films.length;
      updateActiveSlide(prevIndex);
    });

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.getAttribute('data-index'), 10);
        updateActiveSlide(index);
      });
    });
  });
</script>
